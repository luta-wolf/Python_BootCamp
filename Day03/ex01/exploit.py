import pathlib
from bs4 import BeautifulSoup


def get_bs(filepath: pathlib.Path) -> BeautifulSoup | None:
    try:
        with open(filepath) as file:
            soup = BeautifulSoup(file, 'lxml')
        return soup
    except Exception as e:
        print("Read file error\n", e)
        return None


def replace_title(doc: BeautifulSoup):
    titles = doc.head.find_all('title')
    if titles:
        for i in titles:
            i.string = "Evil Corp - Stealing your money every day"
    else:
        new_title = doc.new_tag('title')
        new_title.string = "Evil Corp - Stealing your money every day"
        doc.head.append(new_title)


def change_welcome(doc: BeautifulSoup):
    try:
        pronoun = doc.find('span', {'class': 'pronoun'}).string
    except:
        pronoun = ""

    try:
        name = doc.find('span', {'class': 'name'}).contents[-1]
    except:
        name = ""

    new_welcome = doc.new_tag('h1')
    new_welcome.string = f"{pronoun}{name}, you are hacked"
    doc.body.insert(2, new_welcome)


def add_script(doc: BeautifulSoup):
    script = doc.new_tag('script')
    script.string = """
    hacked=function(){alert("hacked")},window.addEventListener("load",function(){document.querySelector("form").setAttribute("onsubmit","hacked()")},!1);
    """
    doc.body.append(script)


def change_bottom_link(doc: BeautifulSoup):
    link = doc.body.find_all('a')[-1]
    link['href'] = "https://mrrobot.fandom.com/wiki/Fsociety"
    link.string = "Fsociety"


def main():
    c_path = pathlib.Path.cwd()
    source_path = c_path.parent.parent.joinpath('materials', 'evilcorp.html')
    dest_path = source_path.parent.joinpath("evilcorp_hacked.html")

    doc = get_bs(source_path)

    if not doc:
        exit(1)

    try:
        replace_title(doc)
        change_welcome(doc)
        add_script(doc)
        change_bottom_link(doc)
        with open(dest_path, 'w', encoding="utf-8") as file:
            file.write(str(doc))
        print(f"result saved, destination {dest_path}")
    except Exception as e:
        print(e)
        exit(1)


if __name__ == "__main__":
    main()
